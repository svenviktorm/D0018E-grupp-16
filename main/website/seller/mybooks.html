<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <link rel="stylesheet" href="../stylesheat.css">
    <title>Seller Page</title>
</head>

<body>

<!-- Top menue -->
<div class="topnav">
    <a  href="../start.html">Book Store</a>
    <a  href="../seller/myorders.html">My Orders</a>
    <a class="active" href="../seller/mybooks.html">My Books</a>
    <a  href="../seller/mystorefront.html">My Storefront</a>
    <a  href="../myaccount.html">My Account</a>
    <a  href="javascript:void(0);"
           onclick="logout()">Log Out</a>
</div>

<button id="showform">Add book</button>

<div class="flex-container">
    <div id="addbook">
        <card>
            <div class="flex-container">
                <form id="addBookForm">   
                    <input name="title" type="text" placeholder="Title" id="title"><br>
                    <input name="author" type="text" placeholder="Author" id="author"><br>
                    <textarea name="description" placeholder="Description" id="description" rows="1" style="resize: none; overflow: hidden;"></textarea><br>
                    <input name="price" type="number" placeholder="Price" id="price"><br>
                    <input name="edition" type="text" placeholder="Edition" id="edition"><br>
                    <input name="stockAmount" type="number" placeholder="Stock" id="stockAmount"><br>
                    <input name="isbn" type="number" placeholder="ISBN" id="isbn"><br>
                    <input type="submit" value="Submit">
                </form>
            </div>
        </card>
    </div>
</div>

<div class="flex-container" style="display: none;">
    <div id="edit">
        <card>
            <div class="flex-container">
                <form id="editBookForm">   
                    <input name="title" type="text" placeholder="Title" id="title"><br>
                    <textarea name="description" placeholder="Description" id="description" rows="1" style="resize: none; overflow: hidden;"></textarea><br>
                    <input name="price" type="number" placeholder="Price" id="price"><br>
                    <input name="edition" type="text" placeholder="Edition" id="edition"><br>
                    <input name="stockAmount" type="number" placeholder="Stock" id="stockAmount"><br>
                    <input name="isbn" type="number" placeholder="ISBN" id="isbn"><br>
                    <input type="submit" value="Submit">
                </form>
            </div>
        </card>
    </div>
</div>

<div class="row">
    <!--<button id="viewBooksButton">books</button>-->
    <div id="books"></div>
</div>

<div class="row">
    <div id="detailedBooksCard"></div>
</div>
    
<!-- JAVASCRIPT starts here-->
<script>

viewBooks()

async function logout(){
    try {
    const response = await fetch("/API/sessions", {
      method: "DELETE",
      redirect: "follow"
    });
    //if (response.ok){
        location.href=response.url
    //} else {
        //TODO handle errors??
    //}
    
  } catch (e) {
    console.error(e);
  }
}

document.getElementById("description").addEventListener("input", function () {
    this.style.height = "auto";
    this.style.height = this.scrollHeight + "px"
});
const button = document.getElementById("showform")
const form = document.getElementById("addbook")
const editbutton = document.getElementById("editbutton")
const editform = document.getElementById("edit")
//const viewBooksButton = document.getElementById("viewBooksButton");

button.addEventListener("click", function() {
    if (form.style.display === "none" || form.style.display === "") {
        form.style.display = "block";
        button.textContent = "Back";
    } else {
        form.style.display = "none";
        button.textContent = "Add book";
    }
})

editbutton.addEventListener("click", function() {
    if (editform.style.display === "none" || editform.style.display === "") {
        editform.style.display = "block";
        editbutton.textContent = "Back";
    } else {
        editform.style.display = "none";
        editbutton.textContent = "Edit";
    }
})

function getCookie(name) {
    const cookieString = document.cookie;
    if (cookieString) {
        const cookies = cookieString.split(';')
        for (let cookie of cookies) {
        const [cookieName, cookieValue] = cookie.trim().split('=')
        if (cookieName === name) {
            return cookieValue;
        }
        }
    }
    return null;
}

document.getElementById("addBookForm").addEventListener("submit", async function(event) {
    event.preventDefault();  

    const User = {
        username: document.cookie.split("; ").find((row) => row.startsWith("Username="))?.split("=")[1],
        password: document.cookie.split("; ").find((row) => row.startsWith("Username="))?.split("=")[1]
    }
    console.log(getCookie("SellerID"))
    const Book = {
        sellerId: getCookie("SellerID"),
        title: document.getElementById("title").value,
        author: document.getElementById("author").value,
        description: {String: document.getElementById("description").value, Valid: true},
        price: {Int32: parseInt(document.getElementById("price").value, 10), Valid: true},
        edition: {String: document.getElementById("edition").value, Valid: true},
        stockAmount: parseInt(document.getElementById("stockAmount").value, 10),
        isbn: {Int32: parseInt(document.getElementById("isbn").value, 10), Valid: true},
        available: true
    };

    console.log(getCookie(""))
    console.log(document.cookie)
    console.log(getCookie('Username'))
    console.log("Sending book data:", JSON.stringify(User) + JSON.stringify(Book))

    try { 
        const response = await fetch("/add_book", { 
            method: "POST", 
            //headers: { "Content-Type": "application/json" },
            body: JSON.stringify(Book)
        });

        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`HTTP ${response.status}: ${errorText}`)
        }

        const result = await response.json()

        console.log("Added book", result)
        alert("Added book succesfully")
        viewBooks()
    } catch (error) { 
        console.error("Error adding book", error)
        alert("Error adding book")
    }
    document.getElementById("addBookForm").reset()
}); 

async function viewBooks() {
    console.log("cookies:");
    console.log(document.cookie)

    try {
        const response = await fetch("/viewSellerBook", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
        });

        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${await response.text()}`)
        }

        const jsonData = await response.json()
        console.log(jsonData)

        if (!jsonData.books || !Array.isArray(jsonData.books)) {
            throw new Error("Invalid data format")
        }

        const books = document.getElementById("books")
        books.innerHTML = ""

        const availableBooks = jsonData.books.filter(book => book.available)
        const unavailableBooks = jsonData.books.filter(book => !book.available)

        function renderBooks(bookList, sectionTitle) {
            if (bookList.length > 0) {
                books.innerHTML += `<div class='row'><h3>${sectionTitle}</h3></div>`
                bookList.forEach((book) => {
                    const templateBook = `<div class="card" id="book-${book.bookId}" data-bookid="${book.bookId}"><div class="container"><h4><b>${book.title}</b></h4><p>Price: ${book.price.Int32 ?? "Unknown"}</p><p>Edition: ${book.edition || "Unknown"}</p><p>Stock: ${book.stockAmount}</p><p>Available: ${book.available}</p><p>ISBN: ${book.isbn.Int32 ?? "Unknown"}</p></div></div>`
                    books.innerHTML += templateBook
                })
            } else {
                books.innerHTML += `<div class='row'><h3>No ${sectionTitle}</h3></div>`
            }
        }

        renderBooks(availableBooks, "Available Books")
        renderBooks(unavailableBooks, "Unavailable Books")

        books.addEventListener("click", (event) => {
        const card = event.target.closest(".card")
        if (card) {
            const bookId = parseInt(card.getAttribute("data-bookid"), 10)
            console.log("Clicked bookId:", bookId)

            const book = jsonData.books.find(b => {
                console.log("Comparing with bookId:", b.bookId)
                return parseInt(b.bookId, 10) === bookId
            });

            if (book) {
                console.log("Found book:", book)
                showBookDetails(book)
            } else {
                console.log("Book not found for bookId:", bookId)
            }
        }
    })
    

    } catch (error) {
        console.error("Error:", error)
        document.getElementById("books").innerHTML = `<p>Error: ${error.message}</p>`
    }
}

function showBookDetails(book) {
    console.log("Showing book details for:", book.title)

    const books = document.getElementById("books")
    
    const detailedBookHTML = `
        <div id="detailedCard" class="detailed-card">
            <h3>Book Details</h3>
            <p><b>Title:</b> ${book.title}</p>
            <p><b>Description:</b> ${book.description || "No description"}</p>
            <p><b>Price:</b> ${book.price.Int32 ?? "Unknown price"}</p>
            <p><b>Edition:</b> ${book.edition || "No edition"}</p>
            <p><b>Stock:</b> ${book.stockAmount}</p>
            <p><b>Available:</b> ${book.available}</p>
            <p><b>ISBN:</b> ${book.isbn.Int32 ?? "Unknown ISBN"}</p>
            <button id="editbutton" onclick="edit(${JSON.stringify(book)})">Edit</button>
            <button onclick="removeBook()">Remove book</button>
            <button onclick="closeDetails()">Close</button>
        </div>`
    
    const existingDetailCard = document.getElementById("detailedCard")
    if (existingDetailCard) {
        existingDetailCard.remove()
    }

    books.innerHTML += detailedBookHTML
}

//viewBooksButton.addEventListener("click", viewBooks)


function closeDetails() {
    const books = document.getElementById("books")
    const detailedCard = document.getElementById("detailedCard")
    if (detailedCard) {
        books.removeChild(detailedCard)
    }
}

function edit(book) {
    const editForm = document.getElementById("edit")
    editForm.style.display = "block"

    document.querySelector("#editBookForm [name='title']").value = book.title
    document.querySelector("#editBookForm [name='description']").value = book.description
    document.querySelector("#editBookForm [name='price']").value = book.price.Int32
    document.querySelector("#editBookForm [name='edition']").value = book.edition
    document.querySelector("#editBookForm [name='stockAmount']").value = book.stockAmount
    document.querySelector("#editBookForm [name='isbn']").value = book.isbn.Int32

    document.getElementById("editBookForm").addEventListener("submit", async function(event) {
        event.preventDefault()

        const updatedBook = {
            bookId: book.bookId,
            title: document.querySelector("#editBookForm [name='title']").value,
            description: { String: document.querySelector("#editBookForm [name='description']").value, Valid: true },
            price: { Int32: parseInt(document.querySelector("#editBookForm [name='price']").value, 10), Valid: true },
            edition: document.querySelector("#editBookForm [name='edition']").value,
            stockAmount: parseInt(document.querySelector("#editBookForm [name='stockAmount']").value, 10),
            isbn: { Int32: parseInt(document.querySelector("#editBookForm [name='isbn']").value, 10), Valid: true },
            available: book.available
        }

        try {
            const response = await fetch("/edit_book", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(updatedBook)
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`HTTP ${response.status}: ${errorText}`)
            }

            const result = await response.json()
            console.log("Edited book", result)
            alert("Book edited successfully")
            editForm.style.display = "none"
            viewBooks();
        } catch (error) {
            console.error("Error editing book", error)
            alert("Error editing book")
        }
    })
}

function removeBook() {

}
</script>

</body>
</html>